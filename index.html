<!DOCTYPE html>
<html lang="ta">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Peace FM Tamil - Live Radio</title>

  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#6A1B9A">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <meta name="description" content="Peace FM Tamil - Live Tamil Radio Streaming">

  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <main class="wrap">
    <header class="topbar">
      <div class="brand">
        <img src="/icon-192.png" alt="Peace FM Logo" class="logo">
        <h1>Peace FM Tamil</h1>
      </div>
      <p class="tag">Live Tamil Radio тАФ Peace Radio</p>
    </header>

    <section class="player">
      <div class="cover">
        <img src="/icon-512.png" alt="Peace FM Cover">
      </div>

      <div class="controls">
        <!-- Set audio src to your worker's stream endpoint (example below uses proxied worker root) -->
        <audio id="radio" preload="none" crossorigin="anonymous">
          <source id="radioSource" src="https://morning-hall-b6c5.vithiyalove.workers.dev/" type="audio/mpeg">
          роЙроЩрпНроХро│рпН роЙро▓ро╛ро╡ро┐ роЖроЯро┐ропрпЛро╡рпИ роЖродро░ро┐роХрпНроХро╡ро┐ро▓рпНро▓рпИ.
        </audio>

        <div class="button-group">
          <button id="playBtn" class="btn play">
            <span class="icon">тЦ╢</span> Play
          </button>
          <button id="stopBtn" class="btn stop">
            <span class="icon">тЦа</span> Stop
          </button>
        </div>

        <div id="status" class="status">Offline</div>
        <div id="loading" class="loading" style="display: none;">
          <div class="spinner" aria-hidden="true"></div>
          <span>роЗрогрпИроХрпНроХро┐ро▒родрпБ...</span>
        </div>

        <div class="meta">
          <div class="song-info">
            <span class="label">роЗрокрпНрокрпЛродрпБ роТро▓ро┐роХрпНроХро┐ро▒родрпБ:</span>
            <div id="songTitle" class="song-title">Peace Radio Tamil</div>
          </div>
          <div id="listeners" class="listeners">роХрпЗроЯрпНрокрпЛро░рпН: тАФ</div>
        </div>
      </div>
    </section>

    <section class="install-prompt" id="installPrompt" style="display: none;">
      <div class="prompt-content">
        <p>ЁЯУ▒ Peace FM-роР роЙроЩрпНроХро│рпН ро╣рпЛроорпН ро╕рпНроХро┐ро░рпАройро┐ро▓рпН роЪрпЗро░рпНроХрпНроХро╡рпБроорпН!</p>
        <button id="installBtn" class="btn-install">роЗройрпНро╕рпНроЯро╛ро▓рпН роЪрпЖропрпН</button>
        <button id="dismissBtn" class="btn-dismiss" aria-label="Dismiss">├Ч</button>
      </div>
    </section>

    <footer class="foot">
      <small>┬й 2025 Peace FM Tamil тАв PWA Ready</small>
    </footer>
  </main>

  <script src="/app.js" defer></script>
</body>
</html>

// app.js - browser logic (DOM, playback, metadata, PWA prompt, SW register)

// DOM Elements
const audio = document.getElementById('radio');
const radioSource = document.getElementById('radioSource');
const playBtn = document.getElementById('playBtn');
const stopBtn = document.getElementById('stopBtn');
const status = document.getElementById('status');
const loading = document.getElementById('loading');
const songTitle = document.getElementById('songTitle');
const listeners = document.getElementById('listeners');
const installPrompt = document.getElementById('installPrompt');
const installBtn = document.getElementById('installBtn');
const dismissBtn = document.getElementById('dismissBtn');

let deferredPrompt;

// Helper: set status
function setStatus(state, message) {
  status.className = 'status';
  if (state === 'live') {
    status.classList.add('live');
    status.textContent = 'Live ЁЯФ┤';
  } else if (state === 'error') {
    status.classList.add('error');
    status.textContent = message || 'Error';
  } else if (state === 'offline') {
    status.textContent = 'Offline';
  } else {
    status.textContent = 'Offline';
  }
}

function showLoading(show) {
  loading.style.display = show ? 'flex' : 'none';
}

// PLAY handler
playBtn.addEventListener('click', async () => {
  playBtn.disabled = true;
  showLoading(true);

  try {
    // Attempt to play. If autoplay blocked, browser will throw NotAllowedError
    await audio.play();
    setStatus('live');
    showLoading(false);
    playBtn.disabled = false;

    // fetch metadata immediately
    fetchMetadata();

    // Setup media session if available
    if ('mediaSession' in navigator) {
      navigator.mediaSession.metadata = new MediaMetadata({
        title: songTitle.textContent || 'Peace FM Tamil',
        artist: 'Peace Radio',
        album: 'Peace Radio',
        artwork: [
          { src: '/icon-192.png', sizes: '192x192', type: 'image/png' },
          { src: '/icon-512.png', sizes: '512x512', type: 'image/png' }
        ]
      });

      navigator.mediaSession.setActionHandler('play', async () => { await audio.play(); });
      navigator.mediaSession.setActionHandler('pause', () => { audio.pause(); });
    }

  } catch (err) {
    console.error('Playback error:', err);
    showLoading(false);
    playBtn.disabled = false;

    if (err.name === 'NotAllowedError') {
      alert('роЙро▓ро╛ро╡ро┐ autoplay-роР родроЯрпБродрпНродрпБро│рпНро│родрпБ тАФ Play рокроЯрпНроЯройрпИ роорпАрогрпНроЯрпБроорпН роЕро┤рпБродрпНродро╡рпБроорпН.');
    } else {
      setStatus('error', 'рокро┐ро┤рпИ');
      alert('ро╕рпНроЯрпНро░рпАроорпН роЗрогрпИроХрпНроХ роорпБроЯро┐ропро╡ро┐ро▓рпНро▓рпИ. роЗрогрпИроп роЗрогрпИрокрпНрокрпИ роЪро░ро┐рокро╛ро░рпНроХрпНроХро╡рпБроорпН.');
    }
  }
});

// STOP handler - DO NOT set currentTime for live streams
stopBtn.addEventListener('click', () => {
  try {
    audio.pause();
  } catch (e) {
    console.warn('Error while pausing:', e);
  }
  setStatus('offline');
  songTitle.textContent = 'Peace Radio Tamil';
  listeners.textContent = 'роХрпЗроЯрпНрокрпЛро░рпН: тАФ';
});

// Audio event listeners
audio.addEventListener('playing', () => {
  setStatus('live');
  showLoading(false);
});

audio.addEventListener('waiting', () => {
  showLoading(true);
});

audio.addEventListener('error', (e) => {
  console.error('Audio error:', e);
  setStatus('error', 'роЗрогрпИрокрпНрокрпБ рокро┐ро┤рпИ');
  showLoading(false);
  playBtn.disabled = false;
});

audio.addEventListener('pause', () => {
  // if paused manually keep offline label
  if (audio.paused) setStatus('offline');
});

// Robust metadata fetch
async function fetchMetadata() {
  const statusUrl = '/api/status'; // proxied endpoint on worker
  try {
    const res = await fetch(statusUrl, { cache: 'no-store' });
    if (!res.ok) throw new Error('Status fetch failed');

    const data = await res.json();
    // different icecast formats: try to find icestats.source or sources
    let source = null;
    if (data.icestats) {
      source = data.icestats.source || data.icestats;
    } else if (data.icestats && data.icestats.source) {
      source = data.icestats.source;
    } else {
      // fallback: maybe direct object or array
      source = data.source || data;
    }

    if (Array.isArray(source)) source = source[0];

    if (source) {
      if (source.title) songTitle.textContent = source.title;
      else if (source.server_name) songTitle.textContent = source.server_name;

      if (typeof source.listeners !== 'undefined') {
        listeners.textContent = `роХрпЗроЯрпНрокрпЛро░рпН: ${source.listeners}`;
      }
    }
  } catch (err) {
    console.log('Metadata fetch error:', err);
    // leave defaults if failed
  }
}

// Poll metadata every 15s while playing
setInterval(() => {
  if (!audio.paused) fetchMetadata();
}, 15000);

// PWA install prompt handling
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  if (localStorage.getItem('installDismissed') !== 'true') {
    installPrompt.style.display = 'block';
  }
});

installBtn.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  console.log('Install outcome:', outcome);
  deferredPrompt = null;
  installPrompt.style.display = 'none';
});

dismissBtn.addEventListener('click', () => {
  installPrompt.style.display = 'none';
  localStorage.setItem('installDismissed', 'true');
});

// Service Worker registration (ensure sw file at root)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js')
      .then(reg => console.log('Service Worker registered:', reg.scope))
      .catch(err => console.error('Service Worker registration failed:', err));
  });
}

// Optional: quickly check stream reachable (non-blocking)
async function quickHealthCheck() {
  try {
    const res = await fetch('/api/status', { cache: 'no-store' });
    if (res.ok) {
      // nothing else; metadata fetch will update UI
    }
  } catch (e) {
    console.warn('Health check failed:', e);
  }
}
quickHealthCheck();
